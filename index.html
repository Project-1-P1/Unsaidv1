<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="UNSAID - Anonymous Ephemeral Messaging">
    <meta name="theme-color" content="#000000">
    <title>UNSAID</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* ================= DESIGN SYSTEM (Global Theme) ================= */
        :root {
            /* Palette */
            --bg: #000000;
            --surface: #111111;
            --border: #2A2A2A;
            --text-main: #E0E0E0;
            --text-muted: #777777;
            --accent: #58A6FF;
            --danger: #FF4444;
            
            /* Typography */
            --font-brand: 'Courier New', monospace;
            --font-ui: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            
            /* Spacing & Layout */
            --header-height: 60px;
            --radius-sm: 6px;
            --radius-md: 12px;
            --radius-lg: 20px;
        }

        /* Reset & Base */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: var(--font-ui);
            margin: 0; padding: 0;
            height: 100vh; /* Fallback */
            height: 100dvh; /* Dynamic Viewport for Mobile Browsers */
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        .hidden { display: none !important; }
        button { cursor: pointer; border: none; outline: none; background: none; color: inherit; padding: 0; }
        a { color: inherit; text-decoration: none; }

        /* ================= 1. NAVIGATION & HEADERS ================= */
        #view-spaces { flex: 1; display: flex; flex-direction: column; height: 100%; }

        .home-header {
            height: var(--header-height);
            padding: 0 15px;
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; gap: 12px;
            background: var(--bg); z-index: 10; flex-shrink: 0;
            padding-top: env(safe-area-inset-top); /* Notch Support */
        }
        
        .brand-title { 
            font-family: var(--font-brand); font-weight: 800; font-size: 1.1rem; 
            letter-spacing: -1px; white-space: nowrap;
        }

        /* Search Component */
        .search-container { flex: 1; position: relative; }
        .search-input {
            width: 100%; background: #111; border: 1px solid #333; color: white;
            padding: 8px 12px; border-radius: var(--radius-sm); font-size: 0.9rem; outline: none;
            font-family: var(--font-ui); transition: border-color 0.2s;
        }
        .search-input:focus { border-color: var(--text-muted); }

        .header-actions { display: flex; gap: 15px; align-items: center; }
        .icon-btn { font-size: 1.3rem; color: var(--text-main); display: flex; align-items: center; justify-content: center; }
        .icon-btn.plus { font-size: 1.6rem; font-weight: 300; }

        /* Spaces List */
        .spaces-list { flex: 1; overflow-y: auto; padding-bottom: 20px; }
        .space-row {
            padding: 16px 20px; border-bottom: 1px solid #1a1a1a;
            display: flex; align-items: center; justify-content: space-between;
            transition: background 0.1s;
        }
        .space-row:active { background: #111; }
        .space-main { font-size: 1rem; font-weight: 500; }
        .space-sub { font-size: 0.8rem; color: var(--text-muted); margin-top: 4px; }

        /* ================= 2. CHAT INTERFACE ================= */
        #view-chat { flex: 1; display: flex; flex-direction: column; background: var(--bg); height: 100%; }

        .chat-header {
            height: 50px; padding: 0 15px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; gap: 15px; background: var(--bg); flex-shrink: 0;
            padding-top: env(safe-area-inset-top);
        }
        .space-title-display { font-weight: 600; font-size: 1rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .back-btn { font-size: 1.2rem; padding: 10px; margin-left: -10px; }

        #thread-header-bar {
            background: #0f0f0f; padding: 12px 15px; font-size: 0.9rem; color: var(--accent);
            border-bottom: 1px solid var(--border); cursor: pointer; display: flex; gap: 10px;
            font-weight: 500; align-items: center; flex-shrink: 0;
        }

        #feed {
            flex: 1; overflow-y: scroll; padding: 0; 
            display: flex; flex-direction: column;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 10px;
        }

        /* ================= 3. MESSAGE COMPONENT ================= */
        @keyframes msgSlideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .msg-container {
            padding: 12px 15px; 
            border-bottom: 1px solid #1a1a1a;
            display: flex; flex-direction: column; gap: 4px;
            position: relative; 
            transition: transform 0.1s linear; 
            background: var(--bg);
            animation: msgSlideIn 0.25s ease-out forwards;
            
            /* Gestures */
            touch-action: pan-y; 
            user-select: none;
        }
        
        .msg-header {
            display: flex; justify-content: space-between; align-items: baseline;
            margin-bottom: 2px;
        }
        .msg-alias {
            font-family: var(--font-brand); font-size: 0.75rem; color: var(--text-muted);
            font-weight: bold; letter-spacing: -0.5px;
        }
        .msg-time { font-size: 0.7rem; color: #444; }

        .msg-body {
            color: var(--text-main); font-size: 0.95rem; line-height: 1.5;
            white-space: pre-wrap; word-break: break-word;
        }
        .own-message .msg-alias { color: var(--accent); }

        .reply-context {
            font-size: 0.75rem; color: #666; margin-bottom: 4px;
            padding-left: 8px; border-left: 2px solid #333;
            cursor: pointer;
        }

        .msg-actions { display: flex; gap: 20px; margin-top: 8px; }
        .action-btn {
            font-size: 0.75rem; color: #555; text-transform: uppercase; letter-spacing: 0.5px;
            padding: 6px 0; font-weight: 600;
        }
        .action-btn:active { color: var(--text-main); }

        /* ================= 4. INPUT & FOOTER ================= */
        .chat-footer { 
            background: var(--bg); padding: 10px; border-top: 1px solid var(--border); flex-shrink: 0;
            padding-bottom: max(10px, env(safe-area-inset-bottom)); /* iPhone X Fix */
        }
        
        .reply-preview-bar {
            background: #111; padding: 8px; margin-bottom: 8px; border-left: 3px solid var(--accent);
            display: flex; justify-content: space-between; font-size: 0.8rem; color: #aaa;
            border-radius: 4px;
        }

        .expiry-bar {
            display: flex; gap: 8px; margin-bottom: 10px; overflow-x: auto; padding-bottom: 2px;
        }
        .expiry-pill {
            background: #0a0a0a; border: 1px solid #333; color: #666;
            padding: 5px 12px; border-radius: 14px; font-size: 0.75rem; white-space: nowrap;
            transition: 0.2s;
        }
        .expiry-pill.active { border-color: var(--accent); color: var(--accent); background: rgba(88, 166, 255, 0.1); }

        .input-row { display: flex; align-items: flex-end; gap: 10px; }
        textarea {
            flex: 1; background: #111; border: 1px solid #333; color: white;
            padding: 12px; border-radius: var(--radius-lg); font-family: inherit; font-size: 1rem;
            resize: none; height: 46px; outline: none; transition: border-color 0.2s;
        }
        textarea:focus { border-color: #555; }
        
        .send-btn {
            color: var(--text-main); font-weight: bold; width: 46px; height: 46px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%; background: #222; flex-shrink: 0;
        }
        .send-btn:active { background: #333; }

        /* ================= 5. MODALS & OVERLAYS ================= */
        #view-create, #view-info {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 50; padding: 20px;
            padding-top: max(20px, env(safe-area-inset-top));
        }

        /* About Section Styles */
        .info-menu-item { 
            padding: 16px 5px; border-bottom: 1px solid #1a1a1a; cursor: pointer; color: #e0e0e0; 
            display: flex; justify-content: space-between; align-items: center; transition: background 0.1s;
        }
        .info-menu-item:active { background-color: #1a1a1a; }
        .info-arrow { color: #444; font-size: 1.2rem; font-weight: 300; }

        /* Report Modal */
        #report-modal {
            position: fixed; bottom: 0; left: 0; width: 100%; background: #151515;
            border-top: 1px solid var(--danger); z-index: 100; padding: 20px;
            padding-bottom: max(20px, env(safe-area-inset-bottom));
            transform: translateY(100%); transition: transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        #report-modal.active { transform: translateY(0); }
        .report-opt { padding: 18px; border-bottom: 1px solid #2a2a2a; color: var(--danger); text-align: center; font-weight: 500; }

    </style>
</head>
<body>

    <div id="view-spaces">
        <header class="home-header">
            <div class="brand-title">UNSAID</div>
            <div class="search-container">
                <input type="text" id="space-search" class="search-input" placeholder="Search..." onkeyup="filterSpaces()">
            </div>
            <div class="header-actions">
                <button class="icon-btn plus" onclick="openCreate()" aria-label="Create Space">Ôºã</button>
                <button class="icon-btn" onclick="openInfo()" aria-label="Information">‚ìò</button>
            </div>
        </header>

        <div class="spaces-list" id="spaces-list-container">
            <div class="space-row" onclick="enterSpace(null)">
                <div>
                    <div class="space-main">üåê Public Space</div>
                    <div class="space-sub">Global Feed</div>
                </div>
            </div>
            <div id="community-spaces-anchor"></div>
        </div>
    </div>

    <div id="view-chat" class="hidden">
        <header class="chat-header">
            <button class="back-btn" onclick="goHome()">‚Üê</button>
            <div class="space-title-display" id="chat-title">Public Space</div>
        </header>

        <div id="thread-header-bar" class="hidden" onclick="exitThread()">
            <span>‚Üê Back to Full Conversation</span>
        </div>

        <div id="feed"></div>

        <footer class="chat-footer">
            <div class="expiry-bar">
                <div class="expiry-pill" onclick="setExpiry(1)" id="exp-1">24h</div>
                <div class="expiry-pill active" onclick="setExpiry(3)" id="exp-3">3 Days</div>
                <div class="expiry-pill" onclick="setExpiry(7)" id="exp-7">7 Days</div>
            </div>

            <div id="reply-bar" class="reply-preview-bar hidden">
                <span id="reply-text">Replying...</span>
                <button onclick="cancelReply()">‚úï</button>
            </div>
            <div class="input-row">
                <textarea id="msg-input" placeholder="Type a message..."></textarea>
                <button class="send-btn" onclick="submitMessage()">‚û§</button>
            </div>
        </footer>
    </div>

    <div id="view-create" class="hidden">
        <h2 style="margin-bottom:30px">New Space</h2>
        <input type="text" id="new-space-name" placeholder="Space Name (e.g. 'library')" 
               style="width:100%; padding:15px; background:#111; border:1px solid #333; color:white; margin-bottom:20px; border-radius:var(--radius-sm);">
        <button onclick="commitCreate()" style="width:100%; padding:15px; background:white; color:black; font-weight:bold; border-radius:var(--radius-sm);">Create</button>
        <button onclick="closeCreate()" style="width:100%; padding:15px; color:#666; margin-top:10px;">Cancel</button>
    </div>

    <div id="view-info" class="hidden">
        <div class="info-sheet" style="display: flex; flex-direction: column; height: 100%; margin-top: 0; padding-top: 10px;">
            
            <div style="display: flex; align-items: center; padding-bottom: 15px; border-bottom: 1px solid #333; margin-bottom: 25px; flex-shrink: 0;">
                <button onclick="closeInfo()" style="font-size: 1.6rem; padding: 0 15px 0 0; color: var(--text-main); line-height: 1;">‚Üê</button>
                <div style="font-family: var(--font-brand); font-size: 1.4rem; font-weight: 800; letter-spacing: -1px; color: var(--text-main);">
                    UNSAID
                </div>
            </div>

            <div style="flex: 1; overflow-y: auto; padding-right: 5px; padding-bottom: 50px;">
                
                <div style="color: #bbbbbb; font-size: 0.95rem; line-height: 1.6;">
                    <p style="margin-bottom: 15px;">UNSAID exists for what is rarely allowed to exist elsewhere.</p>
                    <p style="margin-bottom: 15px;">Most digital spaces require identity, continuity, and visibility. They record, rank, and remember. Over time, expression becomes performance, and silence becomes safer than honesty.</p>
                    <p style="margin-bottom: 15px;">UNSAID is built on a different assumption.</p>
                    <p style="margin-bottom: 15px;">It is a quiet, anonymous environment designed for expression without identity. There are no accounts, no profiles, and no persistent presence. What is shared here is not meant to follow anyone, shape a reputation, or become a record.</p>
                    <p style="margin-bottom: 15px;">Messages exist only for the duration chosen by the person who shares them. When that time ends, they disappear completely. Nothing is archived. Nothing is carried forward.</p>
                    <p style="margin-bottom: 15px;">UNSAID is not a social network. It does not encourage growth, influence, or engagement. It is a communication system‚Äîminimal by design‚Äîcreated to allow thoughts to be expressed and then released.</p>
                    <p style="margin-bottom: 15px;">This project is an independent experimental initiative created by an Electronics & Communication Engineering student at UBDT College of Engineering. It explores what communication looks like when memory, identity, and permanence are intentionally removed.</p>
                    <p style="margin-bottom: 15px;">UNSAID does not ask to be followed.</p>
                    <p style="margin-bottom: 15px;">It does not try to keep you here.</p>
                    <p style="margin-bottom: 30px;">It exists so that something can be said‚Äîand then left behind.</p>
                    <p style="margin-bottom: 40px; color: var(--text-main); font-weight: 600; font-size: 1rem; border-left: 2px solid var(--accent); padding-left: 15px;">
                        Anonymous ‚Äî not permanent.
                    </p>
                </div>

                <div style="border-top: 1px solid #333; padding-top: 25px; margin-bottom: 30px;">
                    <div style="font-size: 0.75rem; color: #666; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; font-weight: 600;">More Information</div>
                    
                   <div class="info-menu-item" onclick="window.location.href='about.html'">
    <span>More About UNSAID</span> <span class="info-arrow">‚Ä∫</span>
</div>

<div class="info-menu-item" onclick="window.location.href='privacy.html'">
    <span>Privacy Policy</span> <span class="info-arrow">‚Ä∫</span>
</div>

<div class="info-menu-item" onclick="window.location.href='terms.html'">
    <span>Terms of Service</span> <span class="info-arrow">‚Ä∫</span>
</div>

<div class="info-menu-item" onclick="window.location.href='developer.html'">
    <span>Developer Contact</span> <span class="info-arrow">‚Ä∫</span>
</div>
                </div>

                <button onclick="closeInfo()" style="width:100%; padding:18px; background:#111; color:var(--text-main); border-radius:8px; border: 1px solid #333; font-weight: 600; margin-bottom: 50px;">
                    Back to Home
                </button>
            </div>
        </div>
    </div>

    <div id="report-modal">
        <div style="text-align:center; color:#666; margin-bottom:15px; font-size:0.9rem;">REPORT MESSAGE</div>
        <div class="report-opt" onclick="submitReport()">Spam / Bot</div>
        <div class="report-opt" onclick="submitReport()">Abusive Content</div>
        <div style="padding:15px; text-align:center; color:white; margin-top:10px;" onclick="closeReport()">Cancel</div>
    </div>

    <script>
        // CONFIGURATION
        const SUPABASE_URL = 'https://fzqadrwoceetmmckfjhs.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ6cWFkcndvY2VldG1tY2tmamhzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0NjEwNDIsImV4cCI6MjA4MjAzNzA0Mn0.pMYMEF9jyfJ4CXD7E9XmLj8QSAWJI5-h5iq4S7tU6HI';
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);

        // APP STATE
        let currentSpace = null;
        let replyTarget = null;
        let feedCache = [];
        let spacesCache = [];
        let currentThreadRoot = null;
        let selectedExpiryDays = 3;
        let mySessionAlias = null;

        // INTERACTION VARS
        let touchStartX = 0;
        let touchStartY = 0;
        let swipedElement = null;

        // INITIALIZATION
        window.onload = function() { 
            initSessionAlias();
            loadSpacesList(); 
            initRealtime(); 
        };

        // --- IDENTITY SYSTEM (Session Based) ---
        function initSessionAlias() {
            let existing = sessionStorage.getItem('unsaid_session_alias');
            if (!existing) {
                const adj = [
                    'Silent','Hazy','Cyber','Lost','Neon','Solar','Lunar','Hollow','Electric',
                    'Static','Glitch','Rapid','Zero','Dark','Bright','Faint','Prime','Echo',
                    'Hidden','Secret','Vivid','Rapid','Blue','Red','Gold','Iron','Steel'
                ];
                const noun = [
                    'Ghost','Signal','Echo','Drifter','Pilot','Shadow','Glitch','Node',
                    'Spark','Voyager','Orbit','Pulse','Wave','Dust','Phantom','Runner',
                    'System','Core','Link','Byte','Pixel','Cipher','Code','Key','Lock'
                ];
                const randomAdj = adj[Math.floor(Math.random() * adj.length)];
                const randomNoun = noun[Math.floor(Math.random() * noun.length)];
                const randomNum = Math.floor(1000 + Math.random() * 9000);
                existing = `${randomAdj}-${randomNoun}-${randomNum}`;
                sessionStorage.setItem('unsaid_session_alias', existing);
            }
            mySessionAlias = existing;
            console.log("User Identity:", mySessionAlias);
        }

// --- NAVIGATION CONTROLLER ---
        function showView(id) {
            ['view-spaces', 'view-chat', 'view-create', 'view-info'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        function enterSpace(name) {
            currentSpace = name;
            
            // CRITICAL FIX: Reset state manually WITHOUT rendering old data
            // We do not use exitThread() here because it triggers a render of the *old* cache.
            currentThreadRoot = null;
            feedCache = []; // Clear memory immediately
            document.getElementById('thread-header-bar').classList.add('hidden');
            
            // Set Loading UI
            document.getElementById('feed').innerHTML = '<div style="padding:40px; text-align:center; color:#333;">Connecting...</div>';
            document.getElementById('chat-title').innerText = name ? `#${name}` : 'Public Space';
            
            showView('view-chat');
            loadMessages();
        }

        function goHome() { 
            currentSpace = null; 
            // Here we can safely use exitThread because we are leaving the chat view anyway
            currentThreadRoot = null;
            document.getElementById('thread-header-bar').classList.add('hidden');
            
            showView('view-spaces'); 
            loadSpacesList();
            document.getElementById('space-search').value = '';
        }

        function openCreate() { showView('view-create'); }
        function closeCreate() { goHome(); }
        function openInfo() { showView('view-info'); }
        function closeInfo() { showView('view-spaces'); }
        // --- SPACES & SEARCH ---
        async function loadSpacesList() {
            const { data } = await db.from('posts')
                .select('space_name')
                .neq('space_name', null)
                .order('created_at', {ascending:false})
                .limit(200);

            if(!data) return;
            const counts = {};
            data.forEach(p => counts[p.space_name] = (counts[p.space_name]||0)+1);
            spacesCache = Object.keys(counts).map(name => ({ name, count: counts[name] }));
            renderSpacesList(spacesCache);
        }

        function renderSpacesList(list) {
            const html = list.map(item => `
                <div class="space-row" onclick="enterSpace('${item.name}')">
                    <div>
                        <div class="space-main">#${item.name}</div>
                        <div class="space-sub">Community Space</div>
                    </div>
                </div>`).join('');
            document.getElementById('community-spaces-anchor').innerHTML = html || '<div style="padding:20px; color:#444; text-align:center">No matches found</div>';
        }

        function filterSpaces() {
            const query = document.getElementById('space-search').value.toLowerCase();
            renderSpacesList(spacesCache.filter(s => s.name.includes(query)));
        }

        function commitCreate() {
            const val = document.getElementById('new-space-name').value.trim().toLowerCase().replace(/[^a-z0-9]/g, '');
            if(val) enterSpace(val);
        }

        // --- MESSAGING ENGINE ---
        async function loadMessages() {
            let query = db.from('posts').select('*').eq('status', 'active').order('created_at', {ascending:true}).limit(100);
            if(currentSpace) query = query.eq('space_name', currentSpace);
            else query = query.is('space_name', null);
            
            const { data } = await query;
            if(data) {
                feedCache = data;
                renderCurrentContext();
            }
        }

        function initRealtime() {
            db.channel('public:posts').on('postgres_changes', {event:'INSERT', schema:'public', table:'posts'}, payload => {
                // Deduplication check
                if (feedCache.find(p => p.id === payload.new.id)) return;
                
                feedCache.push(payload.new);
                const isRelevantSpace = (payload.new.space_name === currentSpace) || (!currentSpace && !payload.new.space_name);
                if(isRelevantSpace) renderCurrentContext();
            }).subscribe();
        }

        function renderCurrentContext() {
            if(currentThreadRoot) viewThread(currentThreadRoot);
            else renderFeed(feedCache);
        }

        // --- THREAD SYSTEM (Recursive) ---
        function viewThread(startId) {
            let root = feedCache.find(p => p.id === startId);
            if(!root) return;
            
            // Climb up to true root
            let parent = root;
            while(parent && parent.thread_id) {
                const found = feedCache.find(p => p.id === parent.thread_id);
                if(found) parent = found;
                else break;
            }
            root = parent;
            currentThreadRoot = root.id;

            // Gather all descendants
            const treeIds = new Set([root.id]);
            let added = true;
            while(added) {
                added = false;
                feedCache.forEach(p => {
                    if(p.thread_id && treeIds.has(p.thread_id) && !treeIds.has(p.id)) {
                        treeIds.add(p.id);
                        added = true;
                    }
                });
            }

            const threadPosts = feedCache.filter(p => treeIds.has(p.id));
            threadPosts.sort((a,b) => new Date(a.created_at) - new Date(b.created_at));

            document.getElementById('thread-header-bar').classList.remove('hidden');
            renderFeed(threadPosts, true);
        }

        function exitThread() {
            currentThreadRoot = null;
            document.getElementById('thread-header-bar').classList.add('hidden');
            renderFeed(feedCache);
        }

        function renderFeed(posts, isThreadView = false) {
            const feed = document.getElementById('feed');
            feed.innerHTML = '';
            
            posts.forEach(post => {
                const el = document.createElement('div');
                el.className = 'msg-container';
                if(post.author_alias === mySessionAlias) el.classList.add('own-message');

                // Gesture Binding
                el.ontouchstart = (e) => handleSwipeStart(e, el);
                el.ontouchmove = (e) => handleSwipeMove(e, el);
                el.ontouchend = (e) => handleSwipeEnd(e, el, post.id, post.content);

                const displayAlias = post.author_alias || 'anonymous';
                const time = new Date(post.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

                let replyCtx = '';
                if(post.thread_id) {
                    const parent = feedCache.find(p => p.id === post.thread_id);
                    const pText = parent ? parent.content.substring(0, 30)+'...' : 'Message unavailable';
                    const pAlias = parent ? (parent.author_alias || 'anon') : 'unknown';
                    replyCtx = `<div class="reply-context" onclick="viewThread('${post.thread_id}')">‚Ü™ <b>${pAlias}</b>: ${escapeHtml(pText)}</div>`;
                }

                el.innerHTML = `
                    <div class="msg-header">
                        <div class="msg-alias">${displayAlias}</div>
                        <div class="msg-time">${time}</div>
                    </div>
                    ${replyCtx}
                    <div class="msg-body">${escapeHtml(post.content)}</div>
                    <div class="msg-actions">
                        <button class="action-btn" onclick="initReply('${post.id}', '${escapeHtml(post.content)}')">Reply</button>
                        <button class="action-btn" onclick="viewThread('${post.id}')">Thread</button>
                        <button class="action-btn" onclick="openReport()">Report</button>
                    </div>
                `;
                feed.appendChild(el);
            });
            if(!isThreadView) feed.scrollTop = feed.scrollHeight;
        }

        // --- GESTURE LOGIC (Swipe to Reply) ---
        function handleSwipeStart(e, el) {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            swipedElement = el;
            el.style.transition = 'none';
        }

        function handleSwipeMove(e, el) {
            if(!swipedElement) return;
            const currentX = e.touches[0].clientX;
            const diffX = currentX - touchStartX;
            const diffY = e.touches[0].clientY - touchStartY;

            // Only horizontal swipe allowed
            if(diffX > 5 && Math.abs(diffY) < 30) {
                if(e.cancelable) e.preventDefault(); // Stop scroll
                const moveAmount = Math.min(diffX, 70);
                el.style.transform = `translateX(${moveAmount}px)`;
            }
        }

        function handleSwipeEnd(e, el, id, content) {
            if(!swipedElement) return;
            const diffX = e.changedTouches[0].clientX - touchStartX;
            
            // Spring animation
            el.style.transition = 'transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1)';
            el.style.transform = 'translateX(0)';
            
            if(diffX > 50 && Math.abs(e.changedTouches[0].clientY - touchStartY) < 30) {
                if(navigator.vibrate) navigator.vibrate(10);
                initReply(id, escapeHtml(content));
            }
            swipedElement = null;
        }

// --- COMPOSER LOGIC ---
        function setExpiry(days) {
            selectedExpiryDays = days;
            document.querySelectorAll('.expiry-pill').forEach(p => p.classList.remove('active'));
            document.getElementById('exp-'+days).classList.add('active');
        }

        function initReply(id, text) {
            replyTarget = { id, text };
            document.getElementById('reply-bar').classList.remove('hidden');
            document.getElementById('reply-text').innerText = `Replying to: ${text.substring(0,20)}...`;
            document.getElementById('msg-input').focus();
        }

        function cancelReply() {
            replyTarget = null;
            document.getElementById('reply-bar').classList.add('hidden');
        }

        async function submitMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text) return;

            const expiry = new Date();
            expiry.setDate(expiry.getDate() + selectedExpiryDays);

            // LOGIC FIX: DETERMINE PARENT ID
            // 1. Is user replying to a specific message? Use that ID.
            // 2. Is user just looking at a thread? Use the Thread Root ID.
            // 3. Otherwise, it is a new main feed post (null).
            let finalThreadId = null;
            
            if (replyTarget) {
                finalThreadId = replyTarget.id;
            } else if (currentThreadRoot) {
                finalThreadId = currentThreadRoot;
            }

            const payload = {
                content: text,
                space_name: currentSpace,
                expiry_time: expiry.toISOString(),
                thread_id: finalThreadId,
                author_alias: mySessionAlias || 'Anonymous-User'
            };

            // Optimistic UI Update
            input.value = '';
            cancelReply();

            const { data, error } = await db.from('posts').insert(payload).select();

            if(error) {
                console.error(error);
                alert("Failed to send. Please check connection.");
            } else {
                if(data && data[0]) {
                    // Only add to feed manually if we haven't received it via Realtime yet
                    if (!feedCache.find(p => p.id === data[0].id)) {
                        feedCache.push(data[0]);
                        renderCurrentContext();
                    }
                }
            }
        }

        // UTILITIES
        function escapeHtml(t) { return t ? t.replace(/&/g,"&amp;").replace(/</g,"&lt;") : ""; }
        function openReport() { document.getElementById('report-modal').classList.add('active'); }
        function closeReport() { document.getElementById('report-modal').classList.remove('active'); }
        function submitReport() { alert("Report submitted."); closeReport(); }
    </script>
</body>
</html>